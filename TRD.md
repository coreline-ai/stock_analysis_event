# MAHORAGA Research-Only 전환 TRD
## Technical Requirements & Design Document

---

## 0. 문서 목적

본 문서는  
**MAHORAGA 리팩토링 기획서** 및 **PRD**를 기술적으로 구현하기 위한  
**기술 설계 문서(TRD)**이다.

이 문서는 다음을 정의한다:

- 시스템 아키텍처
- 주요 모듈 책임 분리
- 실행 모델
- 데이터 흐름
- 안전 장치 및 제약 사항

구체적인 일정, 작업 단위, PR 분할은  
본 문서를 기반으로 이후 개발 계획 문서에서 다룬다.

---

## 1. 기술적 전제 조건

### 1.1 핵심 전제

- 실제 매매 실행은 어떤 환경에서도 불가능해야 한다
- 시스템은 “항상 켜진 서버”를 전제로 하지 않는다
- 모든 실행은 요청 기반 또는 스케줄 트리거 기반이다
- 판단 결과는 반드시 영속 저장된다

---

### 1.2 배포 및 실행 환경

- 배포 플랫폼: Vercel
- 실행 방식:
  - API Routes 기반 서버리스 실행
  - Cron Job 기반 주기 트리거
- 런타임 특성:
  - Stateless execution
  - 실행 시간 제한 존재
  - 병렬 실행 가능성 존재

---

## 2. 전체 시스템 아키텍처 (개념)

시스템은 다음 네 계층으로 구성된다:

- API Layer
- Runner / Scheduler Layer
- Core Pipeline Layer
- Storage / External Adapter Layer

각 계층은 명확히 분리되며, 상위 계층은 하위 계층의 구현 세부사항을 알지 않는다.

---

## 3. 계층별 설계

---

### 3.1 API Layer

#### 책임
- 외부 요청 수신
- 인증 및 접근 제어
- 조회 전용 엔드포인트 제공
- 수동 트리거 제공

#### 주요 엔드포인트 역할
- 상태 조회
- 판단 결과 조회
- 리포트 조회
- 파이프라인 수동 실행 요청

#### 설계 원칙
- API Layer는 비즈니스 로직을 포함하지 않는다
- 모든 실제 처리는 Core Pipeline에 위임한다
- 인증 실패 시 즉시 종료한다

---

### 3.2 Runner / Scheduler Layer

#### 책임
- 파이프라인 실행 트리거
- 중복 실행 방지
- 실행 범위 및 타임박스 제어

#### 실행 방식
- Vercel Cron이 특정 API 엔드포인트 호출
- Runner가 실행 락을 획득한 경우에만 파이프라인 수행
- 락 획득 실패 시 즉시 종료

#### 중복 실행 방지 전략
- 분산 락 사용 (Redis 또는 DB 기반)
- 락은 TTL 기반 자동 해제 방식

---

### 3.3 Core Pipeline Layer (핵심)

#### 책임
- 도메인 로직의 중심
- 플랫폼 독립적 코드 영역
- 테스트 가능 영역

#### 파이프라인 단계
- Gather
- Normalize
- Score
- Decide
- Report

#### 설계 원칙
- Core Pipeline은 Vercel, Cloudflare 등 플랫폼 의존 코드 금지
- 외부 접근은 Adapter를 통해서만 수행
- 파이프라인은 부분 실행이 가능해야 한다

---

### 3.4 Storage / External Adapter Layer

#### 책임
- 데이터 영속 저장
- 외부 서비스 호출
- 구현 교체 가능성 확보

#### 포함 요소
- Database Repository
- Redis Lock Adapter
- LLM Provider Adapter
- Notification Adapter (선택)

#### 설계 원칙
- 인터페이스 기반 설계
- Core Pipeline은 구체 구현을 알지 않는다

---

## 4. 데이터 설계 개요

### 4.1 주요 데이터 엔티티

- Raw Signal
- Scored Signal
- Decision
- Daily Report
- Agent Run

각 엔티티는 생성 시점, 입력 근거, 결과를 명확히 연결해야 한다.

---

### 4.2 재현성 보장

- 모든 Decision은:
  - 사용된 Signal ID 목록
  - 스코어링 결과
  - LLM 입력 요약
과 연결되어야 한다.

---

## 5. Decision Engine 설계

### 5.1 판단 흐름

- 스코어 기준 상위 종목 선별
- LLM 기반 리서치 수행
- 구조화된 Decision 생성
- Decision 영속 저장

---

### 5.2 Decision 정책

- Decision은 반드시 다음 중 하나여야 한다:
  - BUY_NOW
  - WATCH
  - AVOID
- Decision 생성은 실제 매매를 유발하지 않는다
- Decision 생성 실패는 시스템 전체 실패로 간주하지 않는다

---

## 6. 매매 실행 차단 설계 (강제 안전 장치)

### 6.1 기본 원칙

- Trade Execution 코드는 시스템에 존재하지 않거나,
  존재하더라도 항상 실패해야 한다.

---

### 6.2 구현 전략

- Broker 인터페이스는 유지
- 구현체는 ResearchOnlyBroker 단 하나
- 주문 실행 호출 시:
  - 즉시 rejected 처리
  - Decision 기록은 정상 수행

---

### 6.3 환경 안전 장치

- 브로커 관련 환경 변수 존재 시:
  - 애플리케이션 부팅 실패
- 실행 중 주문 관련 코드 경로 도달 시:
  - 즉시 예외 발생

---

## 7. 비용 및 실행 제어

### 7.1 비용 제어

- LLM 호출은 상위 N개 시그널로 제한
- 하루 또는 실행 단위 호출 상한 존재

---

### 7.2 타임박스 처리

- 단일 실행에서 처리량 제한
- 미처리 항목은 다음 실행으로 이월

---

## 8. 장애 및 예외 처리

### 8.1 부분 실패 허용

- 특정 종목 분석 실패는 전체 실행 실패로 이어지지 않는다
- 실패 내역은 기록된다

---

### 8.2 재시도 정책

- 외부 API 실패 시 제한적 재시도 허용
- 무한 재시도 금지

---

## 9. 로그 및 관측

### 9.1 실행 로그

- 실행 시작/종료 시각
- 처리 종목 수
- 성공/실패 건수

---

### 9.2 판단 추적성

- Decision 단위로:
  - 입력
  - 출력
  - 생성 시점
을 추적 가능해야 한다.

---

## 10. 문서 간 관계

- 리팩토링 기획서: 방향과 의도
- PRD: 기능 요구사항
- 본 TRD: 기술 설계
- 개발 계획: 작업 단위 및 일정

본 문서는 개발 계획 수립의 직접적인 입력물이다.

---

## 11. 최종 요약

- MAHORAGA는 Research-Only 시점 판단 엔진으로 재구성된다
- 기술 구조는 플랫폼 독립 Core + 실행 환경 Adapter 구조를 따른다
- 매매 실행은 기술적으로 차단된다
- 본 TRD는 이후 개발 계획의 기준점이다

